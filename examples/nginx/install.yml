---
preExecCmds:
  - if [ -z $(which nginx) ]; then if [ -f /usr/bin/amazon-linux-extras ]; then /usr/bin/amazon-linux-extras enable nginx1; fi; fi
  - mkdir -p /etc/nginx/vhosts/
packageList:
  - openssl
  - nginx
postInstallerCmds:
  - if [ ! -f /tmp/www.example.com.cert ]; then openssl req -new -newkey rsa:4096 -nodes -keyout /tmp/www.example.com.key -out /tmp/www.example.com.csr -subj "/C=US/ST=Virginia/L=Arlington/O=Dave/CN=www.example.com" && openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 -subj "/C=US/ST=Denial/L=Springfield/O=Dis/CN=www.example.com" -keyout /tmp/www.example.com.key  -out /tmp/www.example.com.cert; fi
templates:
  - remoteLocation: https://raw.githubusercontent.com/Nitecon/bruce/main/examples/nginx/templates/etc/nginx/nginx.conf
    localLocation: /etc/nginx/nginx.conf
    perms: 0664
    owner: root
    group: root
    vars:
      - type: value
        output: nginx|apt=www-data  # uses nginx for all platforms that don't use apt installer on those use www-data
        variable: NGINX_USER
  - remoteLocation: /home/ec2-user/default.conf
    localLocation: /etc/nginx/vhosts/default.conf
    owner: root
    group: root
    perms: 0664
  - remoteLocation: https://raw.githubusercontent.com/Nitecon/bruce/main/examples/nginx/templates/var/www/html/index.html
    localLocation: /var/www/html/index.html
    owner: root
    group: root
    perms: 0664
    vars:
      - type: command
        output: hostname -f
        variable: HOSTNAME
chowns:
  #Note this chown is just to show functionality in conjunction with preExecCmds where you potentially may want to do something in cmd and then set ownership prior to service restarts.
  - type: file # can be file / dir
    path: /tmp/www.example.com.key
    owner: nginx|apt=www-data
    group: nginx|apt=www-data
    recursive: false
  - type: file # can be file / dir
    path: /tmp/www.example.com.cert
    owner: nginx|apt=www-data
    group: nginx|apt=www-data
    recursive: false
services:
  - name: nginx
    setEnabled: yes
    state: started
    restartTrigger:
      - /etc/nginx/nginx.conf
      - /etc/nginx/vhosts/default.conf
    restartAlways: no
postExecCmds:
  - echo "nginx should be ready"